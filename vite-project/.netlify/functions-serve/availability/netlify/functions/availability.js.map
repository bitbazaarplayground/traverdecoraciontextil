{
  "version": 3,
  "sources": ["../../../../../../../Users/nicnat/Projects/traverdecoraciontextil/vite-project/netlify/functions/availability.js"],
  "sourceRoot": "/private/var/folders/8f/3rn3yv2d23l5nml9jvqwg7280000gn/T/tmp-46531-81rpNbwKmSM4",
  "sourcesContent": ["// Netlify Function: GET /.netlify/functions/availability?days=14\n// Returns available 1-hour start times that block 2 hours per booking.\n\nfunction json(statusCode, bodyObj) {\n  return {\n    statusCode,\n    headers: {\n      \"Content-Type\": \"application/json; charset=utf-8\",\n      \"Cache-Control\": \"no-store\",\n    },\n    body: JSON.stringify(bodyObj, null, 2),\n  };\n}\n\n/**\n * Parse GMT offset like \"GMT\", \"GMT+1\", \"GMT-0\", \"GMT+01:00\"\n * Returns offset minutes relative to UTC (e.g. +60 for GMT+1).\n */\nfunction parseGmtOffsetToMinutes(tzName) {\n  if (!tzName || tzName === \"GMT\" || tzName === \"UTC\") return 0;\n  // Examples: \"GMT+1\", \"GMT+01:00\", \"GMT-0\", \"GMT-00:30\"\n  const m = tzName.match(/^GMT([+-])(\\d{1,2})(?::?(\\d{2}))?$/);\n  if (!m) return 0;\n  const sign = m[1] === \"-\" ? -1 : 1;\n  const hours = Number(m[2] || 0);\n  const mins = Number(m[3] || 0);\n  return sign * (hours * 60 + mins);\n}\n\n/**\n * Get the timezone offset (minutes) for a given UTC date/time in a target IANA timezone.\n * For Europe/London, this handles DST properly.\n */\nfunction getOffsetMinutesForZone(dateUtc, timeZone) {\n  const dtf = new Intl.DateTimeFormat(\"en-GB\", {\n    timeZone,\n    timeZoneName: \"shortOffset\", // Node 18 supports this\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n    hour12: false,\n  });\n  const parts = dtf.formatToParts(dateUtc);\n  const tzPart = parts.find((p) => p.type === \"timeZoneName\")?.value;\n  return parseGmtOffsetToMinutes(tzPart);\n}\n\n/**\n * Convert a local time in a given zone (YYYY-MM-DD + HH:mm) into a UTC Date.\n * We do this by:\n *  - building a \"fake UTC date\" using the local components\n *  - then subtracting the zone offset at that moment\n */\nfunction zonedLocalToUtcDate({ y, m, d, hh, mm }, timeZone) {\n  // Create a date as if local components were UTC\n  const pretendUtc = new Date(Date.UTC(y, m - 1, d, hh, mm, 0, 0));\n  const offsetMin = getOffsetMinutesForZone(pretendUtc, timeZone);\n  return new Date(pretendUtc.getTime() - offsetMin * 60_000);\n}\n\n/** Format YYYY-MM-DD for a Date in a specific timezone */\nfunction formatYMDInZone(dateUtc, timeZone) {\n  const dtf = new Intl.DateTimeFormat(\"en-CA\", {\n    timeZone,\n    year: \"numeric\",\n    month: \"2-digit\",\n    day: \"2-digit\",\n  });\n  return dtf.format(dateUtc); // en-CA gives YYYY-MM-DD\n}\n\n/** Get weekday (1..7) Monday..Sunday for a date in zone */\nfunction weekdayInZone(dateUtc, timeZone) {\n  const dtf = new Intl.DateTimeFormat(\"en-GB\", { timeZone, weekday: \"short\" });\n  const w = dtf.format(dateUtc).toLowerCase();\n  // mon,tue,wed,thu,fri,sat,sun\n  const map = { mon: 1, tue: 2, wed: 3, thu: 4, fri: 5, sat: 6, sun: 7 };\n  const key = w.slice(0, 3);\n  return map[key] || 7;\n}\n\n/** Simple overlap test: [aStart,aEnd) overlaps [bStart,bEnd) */\nfunction overlaps(aStartMs, aEndMs, bStartMs, bEndMs) {\n  return aStartMs < bEndMs && aEndMs > bStartMs;\n}\n\n/**\n * Opening hours config (local Europe/London).\n * Each day returns one or more segments with { startHour, endHour }.\n * endHour is \"closing hour\" (exclusive).\n */\nfunction getOpeningSegments(weekday /* 1..7 */) {\n  // Example schedule:\n  // Mon-Fri: 09-14 and 16-20\n  // Sat: 10-14\n  // Sun: closed\n  if (weekday >= 1 && weekday <= 5) {\n    return [\n      { startHour: 9, endHour: 13 },\n      { startHour: 16, endHour: 20 },\n    ];\n  }\n  if (weekday === 6) return [{ startHour: 10, endHour: 14 }];\n  return []; // Sunday closed\n}\n\n/**\n * Generate candidate 1-hour start times (local) for a given date,\n * where each booking blocks `blockMinutes` (e.g. 120).\n */\nfunction generateCandidateStartsForDay({ y, m, d }, timeZone, blockMinutes) {\n  const weekday = weekdayInZone(\n    new Date(Date.UTC(y, m - 1, d, 12, 0, 0)),\n    timeZone\n  );\n  const segments = getOpeningSegments(weekday);\n  const candidates = [];\n\n  for (const seg of segments) {\n    const { startHour, endHour } = seg;\n\n    // 1-hour start times, but must fit the block window fully in segment:\n    // start + blockMinutes <= endHour\n    const latestStart = endHour - blockMinutes / 60;\n    for (let hh = startHour; hh <= latestStart; hh += 1) {\n      candidates.push({ hh, mm: 0 });\n    }\n  }\n  return candidates;\n}\n\n/** Fetch rows from Supabase REST using anon key (RLS must allow reads for admin later; for now these tables are protected, so we fetch only public fields that are readable or we switch to service role later.) */\nasync function supabaseGet({ url, serviceKey, path }) {\n  const res = await fetch(`${url}/rest/v1/${path}`, {\n    headers: {\n      apikey: serviceKey,\n      Authorization: `Bearer ${serviceKey}`,\n      \"Content-Type\": \"application/json\",\n    },\n  });\n\n  const text = await res.text();\n  if (!res.ok) {\n    throw new Error(`Supabase GET failed: ${res.status} ${text}`);\n  }\n  return text ? JSON.parse(text) : [];\n}\n\nexport async function handler(event) {\n  try {\n    const SUPABASE_URL = process.env.SUPABASE_URL;\n    const SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;\n    if (!SUPABASE_URL || !SERVICE_KEY) {\n      return json(500, {\n        error: \"Missing SUPABASE_URL or SERVICE_KEY env vars\",\n      });\n    }\n\n    const timeZone = \"Europe/Madrid\";\n\n    const blockMinutes = 120;\n    const leadTimeDays = 2;\n\n    const daysRaw = event.queryStringParameters?.days;\n    const days = Math.max(1, Math.min(30, Number(daysRaw || 14)));\n\n    // Today in Madrid (YYYY-MM-DD)\n    const nowUtc = new Date();\n    const todayYMD = formatYMDInZone(nowUtc, timeZone);\n\n    // Parse YYYY-MM-DD\n    const [ty, tm, td] = todayYMD.split(\"-\").map(Number);\n\n    // earliest bookable date = today + leadTimeDays (in local calendar)\n    const earliestLocalNoonUtc = zonedLocalToUtcDate(\n      { y: ty, m: tm, d: td, hh: 12, mm: 0 },\n      timeZone\n    );\n    const earliestDate = new Date(\n      earliestLocalNoonUtc.getTime() + leadTimeDays * 24 * 60 * 60_000\n    );\n\n    // Build list of days (local dates) starting from earliestDate\n    const dayList = [];\n    for (let i = 0; i < days; i++) {\n      const dUtc = new Date(earliestDate.getTime() + i * 24 * 60 * 60_000);\n      const ymd = formatYMDInZone(dUtc, timeZone);\n      const [y, m, d] = ymd.split(\"-\").map(Number);\n      dayList.push({ y, m, d, ymd });\n    }\n\n    // Define query range in UTC for fetching bookings/blackouts\n    // From first day 00:00 local to last day 23:59 local (converted to UTC)\n    const first = dayList[0];\n    const last = dayList[dayList.length - 1];\n\n    const rangeStartUtc = zonedLocalToUtcDate(\n      { y: first.y, m: first.m, d: first.d, hh: 0, mm: 0 },\n      timeZone\n    );\n    const rangeEndUtc = zonedLocalToUtcDate(\n      { y: last.y, m: last.m, d: last.d, hh: 23, mm: 59 },\n      timeZone\n    );\n\n    // Pull existing reserved bookings + blackouts in a broad range, then filter in JS.\n    // NOTE: This requires your Supabase RLS to allow SELECT for anon on these tables.\n    // If you\u2019ve locked them down (recommended), we\u2019ll switch this function to use SERVICE_ROLE via Netlify secrets in Step 2.\n    const bookings = await supabaseGet({\n      url: SUPABASE_URL,\n      serviceKey: SERVICE_KEY,\n      path:\n        `bookings?select=id,start_time,end_time,status` +\n        `&status=eq.reserved` +\n        `&start_time=lt.${encodeURIComponent(rangeEndUtc.toISOString())}` +\n        `&end_time=gt.${encodeURIComponent(rangeStartUtc.toISOString())}`,\n    });\n\n    const blackouts = await supabaseGet({\n      url: SUPABASE_URL,\n      serviceKey: SERVICE_KEY,\n      path:\n        `blackouts?select=id,start_time,end_time,reason` +\n        `&start_time=lt.${encodeURIComponent(rangeEndUtc.toISOString())}` +\n        `&end_time=gt.${encodeURIComponent(rangeStartUtc.toISOString())}`,\n    });\n\n    const busyRanges = [\n      ...bookings\n        .filter((b) => b.start_time && b.end_time)\n        .map((b) => ({\n          kind: \"booking\",\n          startMs: new Date(b.start_time).getTime(),\n          endMs: new Date(b.end_time).getTime(),\n        })),\n      ...blackouts\n        .filter((b) => b.start_time && b.end_time)\n        .map((b) => ({\n          kind: \"blackout\",\n          startMs: new Date(b.start_time).getTime(),\n          endMs: new Date(b.end_time).getTime(),\n        })),\n    ];\n\n    const outputDays = [];\n\n    for (const day of dayList) {\n      const candidates = generateCandidateStartsForDay(\n        day,\n        timeZone,\n        blockMinutes\n      );\n\n      const slots = [];\n      for (const c of candidates) {\n        const startUtc = zonedLocalToUtcDate(\n          { y: day.y, m: day.m, d: day.d, hh: c.hh, mm: c.mm },\n          timeZone\n        );\n        const endUtc = new Date(startUtc.getTime() + blockMinutes * 60_000);\n\n        const startMs = startUtc.getTime();\n        const endMs = endUtc.getTime();\n\n        // Filter overlaps\n        const blocked = busyRanges.some((r) =>\n          overlaps(startMs, endMs, r.startMs, r.endMs)\n        );\n        if (blocked) continue;\n\n        slots.push({\n          label: `${String(c.hh).padStart(2, \"0\")}:00`,\n          start: startUtc.toISOString(),\n          end: endUtc.toISOString(),\n          blockMinutes,\n        });\n      }\n\n      // Only include days that have opening segments (and potential slots)\n      // (Optional: include empty days if you want calendar to show them)\n      outputDays.push({\n        date: day.ymd,\n        slots,\n      });\n    }\n\n    return json(200, {\n      timezone: timeZone,\n      leadTimeDays,\n      blockMinutes,\n      days: outputDays,\n    });\n  } catch (err) {\n    return json(500, {\n      error: err?.message || \"Unknown error\",\n    });\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
