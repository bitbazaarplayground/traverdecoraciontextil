{
  "version": 3,
  "sources": ["../../../../../../../Users/nicnat/Projects/traverdecoraciontextil/vite-project/netlify/functions/admin-bookings.js"],
  "sourceRoot": "/private/var/folders/8f/3rn3yv2d23l5nml9jvqwg7280000gn/T/tmp-46531-Gybee5MVeMNf",
  "sourcesContent": ["function json(statusCode, body) {\n  return {\n    statusCode,\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"Cache-Control\": \"no-store\",\n    },\n    body: JSON.stringify(body),\n  };\n}\n\nfunction getAllowedEmails() {\n  const raw = process.env.VITE_ADMIN_EMAILS || \"\";\n  return raw\n    .split(\",\")\n    .map((s) => s.trim().toLowerCase())\n    .filter(Boolean);\n}\n\n// Verify the Supabase JWT and return the user (email)\nasync function getUserFromJwt({ supabaseUrl, serviceKey, jwt }) {\n  const res = await fetch(`${supabaseUrl}/auth/v1/user`, {\n    headers: {\n      apikey: serviceKey,\n      Authorization: `Bearer ${jwt}`,\n    },\n  });\n\n  const data = await res.json().catch(() => ({}));\n  if (!res.ok) return { user: null, error: data };\n  return { user: data, error: null };\n}\n\nasync function supabaseRestGet({ supabaseUrl, serviceKey, path }) {\n  const res = await fetch(`${supabaseUrl}/rest/v1/${path}`, {\n    headers: {\n      apikey: serviceKey,\n      Authorization: `Bearer ${serviceKey}`,\n      \"Content-Type\": \"application/json\",\n    },\n  });\n  const text = await res.text();\n  if (!res.ok) throw new Error(text || `Supabase GET failed: ${res.status}`);\n  return text ? JSON.parse(text) : [];\n}\n\nfunction digitsOnly(value) {\n  return String(value || \"\").replace(/\\D+/g, \"\");\n}\n\nfunction normalizeKey(raw) {\n  const v = String(raw || \"\").trim();\n  if (!v) return \"\";\n  if (v.includes(\"@\")) return v.toLowerCase();\n  return digitsOnly(v);\n}\n\n// Canonical key:\n// 1) use DB column customer_key if present\n// 2) else email\n// 3) else phone digits\nfunction getCustomerKey(bk) {\n  const fromDb = normalizeKey(bk?.customer_key);\n  if (fromDb) return fromDb;\n\n  const email = normalizeKey(bk?.email);\n  if (email) return email;\n\n  const phone = normalizeKey(bk?.phone);\n  return phone;\n}\n\nexport async function handler(event) {\n  try {\n    const SUPABASE_URL = process.env.SUPABASE_URL;\n    const SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\n    if (!SUPABASE_URL || !SERVICE_KEY) {\n      return json(500, {\n        error: \"Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY\",\n      });\n    }\n\n    const authHeader =\n      event.headers.authorization || event.headers.Authorization || \"\";\n    const jwt = authHeader.startsWith(\"Bearer \")\n      ? authHeader.slice(\"Bearer \".length)\n      : null;\n\n    if (!jwt) return json(401, { error: \"Missing Authorization token\" });\n\n    // Validate user via Supabase Auth API\n    const { user, error } = await getUserFromJwt({\n      supabaseUrl: SUPABASE_URL,\n      serviceKey: SERVICE_KEY,\n      jwt,\n    });\n\n    if (error || !user?.email) return json(401, { error: \"Invalid session\" });\n\n    // Allow-list\n    const allow = getAllowedEmails();\n    const email = user.email.toLowerCase();\n    if (allow.length && !allow.includes(email)) {\n      return json(403, { error: \"Not authorized\" });\n    }\n\n    const qs = new URLSearchParams(event.queryStringParameters || {});\n    const limit = Math.min(Number(qs.get(\"limit\") || 200), 500);\n\n    // Fetch bookings + enquiries + blackouts\n    // \u2705 Must include customer_key (we use select=*)\n    const bookings = await supabaseRestGet({\n      supabaseUrl: SUPABASE_URL,\n      serviceKey: SERVICE_KEY,\n      path: `bookings?select=*&status=eq.reserved&order=start_time.asc&limit=${limit}`,\n    });\n\n    const enquiries = await supabaseRestGet({\n      supabaseUrl: SUPABASE_URL,\n      serviceKey: SERVICE_KEY,\n      path: `bookings?select=*&status=eq.enquiry&order=created_at.desc&limit=${limit}`,\n    });\n\n    const blackouts = await supabaseRestGet({\n      supabaseUrl: SUPABASE_URL,\n      serviceKey: SERVICE_KEY,\n      path: `blackouts?select=*&order=start_time.asc&limit=${limit}`,\n    });\n\n    // Fetch customer statuses (small table, safe to grab all)\n    const customers = await supabaseRestGet({\n      supabaseUrl: SUPABASE_URL,\n      serviceKey: SERVICE_KEY,\n      path: `customers?select=customer_key,status,updated_at&limit=2000`,\n    });\n\n    const statusByKey = new Map();\n    for (const c of customers || []) {\n      const k = normalizeKey(c.customer_key);\n      if (!k) continue;\n      statusByKey.set(k, (c.status || \"nuevo\").trim().toLowerCase());\n    }\n\n    // \u2705 Merge helper (DO NOT overwrite booking/enquiry status!)\n    function mergeRow(bk) {\n      const customer_key = getCustomerKey(bk);\n      const customer_status = customer_key\n        ? statusByKey.get(customer_key) || bk.status_admin || \"nuevo\"\n        : bk.status_admin || \"nuevo\";\n\n      return {\n        ...bk,\n        customer_key,\n        customer_status, // \u2705 pipeline status lives here\n      };\n    }\n\n    const bookingsMerged = (bookings || []).map(mergeRow);\n    const enquiriesMerged = (enquiries || []).map(mergeRow);\n\n    return json(200, {\n      ok: true,\n      bookings: bookingsMerged,\n      enquiries: enquiriesMerged,\n      blackouts,\n    });\n  } catch (e) {\n    return json(500, { error: e.message || \"Internal error\" });\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAAS,KAAK,YAAY,MAAM;AAC9B,SAAO;AAAA,IACL;AAAA,IACA,SAAS;AAAA,MACP,gBAAgB;AAAA,MAChB,iBAAiB;AAAA,IACnB;AAAA,IACA,MAAM,KAAK,UAAU,IAAI;AAAA,EAC3B;AACF;AAEA,SAAS,mBAAmB;AAC1B,QAAM,MAAM,QAAQ,IAAI,qBAAqB;AAC7C,SAAO,IACJ,MAAM,GAAG,EACT,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,YAAY,CAAC,EACjC,OAAO,OAAO;AACnB;AAGA,eAAe,eAAe,EAAE,aAAa,YAAY,IAAI,GAAG;AAC9D,QAAM,MAAM,MAAM,MAAM,GAAG,WAAW,iBAAiB;AAAA,IACrD,SAAS;AAAA,MACP,QAAQ;AAAA,MACR,eAAe,UAAU,GAAG;AAAA,IAC9B;AAAA,EACF,CAAC;AAED,QAAM,OAAO,MAAM,IAAI,KAAK,EAAE,MAAM,OAAO,CAAC,EAAE;AAC9C,MAAI,CAAC,IAAI,GAAI,QAAO,EAAE,MAAM,MAAM,OAAO,KAAK;AAC9C,SAAO,EAAE,MAAM,MAAM,OAAO,KAAK;AACnC;AAEA,eAAe,gBAAgB,EAAE,aAAa,YAAY,KAAK,GAAG;AAChE,QAAM,MAAM,MAAM,MAAM,GAAG,WAAW,YAAY,IAAI,IAAI;AAAA,IACxD,SAAS;AAAA,MACP,QAAQ;AAAA,MACR,eAAe,UAAU,UAAU;AAAA,MACnC,gBAAgB;AAAA,IAClB;AAAA,EACF,CAAC;AACD,QAAM,OAAO,MAAM,IAAI,KAAK;AAC5B,MAAI,CAAC,IAAI,GAAI,OAAM,IAAI,MAAM,QAAQ,wBAAwB,IAAI,MAAM,EAAE;AACzE,SAAO,OAAO,KAAK,MAAM,IAAI,IAAI,CAAC;AACpC;AAEA,SAAS,WAAW,OAAO;AACzB,SAAO,OAAO,SAAS,EAAE,EAAE,QAAQ,QAAQ,EAAE;AAC/C;AAEA,SAAS,aAAa,KAAK;AACzB,QAAM,IAAI,OAAO,OAAO,EAAE,EAAE,KAAK;AACjC,MAAI,CAAC,EAAG,QAAO;AACf,MAAI,EAAE,SAAS,GAAG,EAAG,QAAO,EAAE,YAAY;AAC1C,SAAO,WAAW,CAAC;AACrB;AAMA,SAAS,eAAe,IAAI;AAC1B,QAAM,SAAS,aAAa,IAAI,YAAY;AAC5C,MAAI,OAAQ,QAAO;AAEnB,QAAM,QAAQ,aAAa,IAAI,KAAK;AACpC,MAAI,MAAO,QAAO;AAElB,QAAM,QAAQ,aAAa,IAAI,KAAK;AACpC,SAAO;AACT;AAEA,eAAsB,QAAQ,OAAO;AACnC,MAAI;AAwEF,QAAS,WAAT,SAAkB,IAAI;AACpB,YAAM,eAAe,eAAe,EAAE;AACtC,YAAM,kBAAkB,eACpB,YAAY,IAAI,YAAY,KAAK,GAAG,gBAAgB,UACpD,GAAG,gBAAgB;AAEvB,aAAO;AAAA,QACL,GAAG;AAAA,QACH;AAAA,QACA;AAAA;AAAA,MACF;AAAA,IACF;AAlFA,UAAM,eAAe,QAAQ,IAAI;AACjC,UAAM,cAAc,QAAQ,IAAI;AAEhC,QAAI,CAAC,gBAAgB,CAAC,aAAa;AACjC,aAAO,KAAK,KAAK;AAAA,QACf,OAAO;AAAA,MACT,CAAC;AAAA,IACH;AAEA,UAAM,aACJ,MAAM,QAAQ,iBAAiB,MAAM,QAAQ,iBAAiB;AAChE,UAAM,MAAM,WAAW,WAAW,SAAS,IACvC,WAAW,MAAM,UAAU,MAAM,IACjC;AAEJ,QAAI,CAAC,IAAK,QAAO,KAAK,KAAK,EAAE,OAAO,8BAA8B,CAAC;AAGnE,UAAM,EAAE,MAAM,MAAM,IAAI,MAAM,eAAe;AAAA,MAC3C,aAAa;AAAA,MACb,YAAY;AAAA,MACZ;AAAA,IACF,CAAC;AAED,QAAI,SAAS,CAAC,MAAM,MAAO,QAAO,KAAK,KAAK,EAAE,OAAO,kBAAkB,CAAC;AAGxE,UAAM,QAAQ,iBAAiB;AAC/B,UAAM,QAAQ,KAAK,MAAM,YAAY;AACrC,QAAI,MAAM,UAAU,CAAC,MAAM,SAAS,KAAK,GAAG;AAC1C,aAAO,KAAK,KAAK,EAAE,OAAO,iBAAiB,CAAC;AAAA,IAC9C;AAEA,UAAM,KAAK,IAAI,gBAAgB,MAAM,yBAAyB,CAAC,CAAC;AAChE,UAAM,QAAQ,KAAK,IAAI,OAAO,GAAG,IAAI,OAAO,KAAK,GAAG,GAAG,GAAG;AAI1D,UAAM,WAAW,MAAM,gBAAgB;AAAA,MACrC,aAAa;AAAA,MACb,YAAY;AAAA,MACZ,MAAM,mEAAmE,KAAK;AAAA,IAChF,CAAC;AAED,UAAM,YAAY,MAAM,gBAAgB;AAAA,MACtC,aAAa;AAAA,MACb,YAAY;AAAA,MACZ,MAAM,mEAAmE,KAAK;AAAA,IAChF,CAAC;AAED,UAAM,YAAY,MAAM,gBAAgB;AAAA,MACtC,aAAa;AAAA,MACb,YAAY;AAAA,MACZ,MAAM,iDAAiD,KAAK;AAAA,IAC9D,CAAC;AAGD,UAAM,YAAY,MAAM,gBAAgB;AAAA,MACtC,aAAa;AAAA,MACb,YAAY;AAAA,MACZ,MAAM;AAAA,IACR,CAAC;AAED,UAAM,cAAc,oBAAI,IAAI;AAC5B,eAAW,KAAK,aAAa,CAAC,GAAG;AAC/B,YAAM,IAAI,aAAa,EAAE,YAAY;AACrC,UAAI,CAAC,EAAG;AACR,kBAAY,IAAI,IAAI,EAAE,UAAU,SAAS,KAAK,EAAE,YAAY,CAAC;AAAA,IAC/D;AAgBA,UAAM,kBAAkB,YAAY,CAAC,GAAG,IAAI,QAAQ;AACpD,UAAM,mBAAmB,aAAa,CAAC,GAAG,IAAI,QAAQ;AAEtD,WAAO,KAAK,KAAK;AAAA,MACf,IAAI;AAAA,MACJ,UAAU;AAAA,MACV,WAAW;AAAA,MACX;AAAA,IACF,CAAC;AAAA,EACH,SAAS,GAAG;AACV,WAAO,KAAK,KAAK,EAAE,OAAO,EAAE,WAAW,iBAAiB,CAAC;AAAA,EAC3D;AACF;",
  "names": []
}
